# 1inch Fusion Plus Tron Integration Makefile
# Simplifies testing, deployment, and development workflows

.PHONY: help install compile test test-unit test-integration test-verbose clean deploy-dev deploy-shasta deploy-nile deploy-mainnet lint format

# Default target
help:
	@echo "ğŸš€ 1inch Fusion Plus Tron Integration Commands"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ“¦ Setup:"
	@echo "  make install      Install dependencies"
	@echo "  make compile      Compile smart contracts"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test         Run complete test suite"
	@echo "  make test-unit    Run unit tests only"
	@echo "  make test-integration  Run integration tests only"
	@echo "  make test-verbose Run tests with verbose output"
	@echo "  make test-clean   Clean build and run tests"
	@echo ""
	@echo "ğŸš€ Deployment:"
	@echo "  make deploy-dev   Deploy to development network"
	@echo "  make deploy-shasta Deploy to Shasta testnet"
	@echo "  make deploy-nile  Deploy to Nile testnet"
	@echo "  make deploy-mainnet Deploy to mainnet (âš ï¸ CAUTION)"
	@echo ""
	@echo "ğŸ”§ Development:"
	@echo "  make clean        Clean build artifacts"
	@echo "  make lint         Run Solidity linter"
	@echo "  make format       Format code"
	@echo "  make verify       Verify deployed contracts"
	@echo ""
	@echo "ğŸ“Š Analysis:"
	@echo "  make coverage     Run test coverage analysis"
	@echo "  make gas-report   Generate gas usage report"
	@echo ""

# Setup and dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	npm install
	@echo "âœ… Dependencies installed"

compile:
	@echo "ğŸ”¨ Compiling smart contracts..."
	npm run compile
	@echo "âœ… Contracts compiled"

# Testing commands
test:
	@echo "ğŸ§ª Running complete test suite..."
	npm test

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	npm run test:unit

test-integration:
	@echo "ğŸ§ª Running integration tests..."
	npm run test:integration

test-verbose:
	@echo "ğŸ§ª Running tests with verbose output..."
	npm run test:verbose

test-clean: clean compile test

coverage:
	@echo "ğŸ“Š Generating test coverage report..."
	npm run test:coverage

# Deployment commands
deploy-dev:
	@echo "ğŸš€ Deploying to development network..."
	npm run deploy:development

deploy-shasta:
	@echo "ğŸš€ Deploying to Shasta testnet..."
	@echo "âš ï¸  Make sure you have test TRX in your account"
	npm run deploy:shasta

deploy-nile:
	@echo "ğŸš€ Deploying to Nile testnet..."
	@echo "âš ï¸  Make sure you have test TRX in your account"
	npm run deploy:nile

deploy-mainnet:
	@echo "ğŸš€ Deploying to MAINNET..."
	@echo "âš ï¸  âš ï¸  WARNING: This will deploy to MAINNET! âš ï¸  âš ï¸"
	@echo "âš ï¸  Make sure you have real TRX and have tested thoroughly!"
	@read -p "Are you sure? Type 'yes' to continue: " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		npm run deploy:mainnet; \
	else \
		echo "âŒ Deployment cancelled"; \
	fi

# Development tools
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	npm run clean
	@echo "âœ… Build artifacts cleaned"

lint:
	@echo "ğŸ” Running Solidity linter..."
	npm run lint

format:
	@echo "âœ¨ Formatting code..."
	npm run format

verify:
	@echo "ğŸ” Verifying deployed contracts..."
	npm run verify

# Analysis and reporting
gas-report:
	@echo "â›½ Generating gas usage report..."
	@echo "Running tests with gas reporting..."
	tronbox test --reporter eth-gas-reporter

# Quick development workflow
dev-setup: install compile test
	@echo "ğŸ‰ Development environment ready!"

# Full CI/CD workflow simulation
ci: clean install compile lint test
	@echo "ğŸ‰ CI/CD pipeline completed successfully!"

# Emergency commands
emergency-clean:
	@echo "ğŸš¨ Emergency cleanup..."
	rm -rf node_modules build .nyc_output
	npm install
	@echo "âœ… Emergency cleanup completed"

# Network status checks
check-networks:
	@echo "ğŸŒ Checking network configurations..."
	@echo "Development network:"
	@tronbox networks | grep development || echo "âŒ Development network not configured"
	@echo "Shasta testnet:"
	@tronbox networks | grep shasta || echo "âŒ Shasta network not configured"
	@echo "Nile testnet:"
	@tronbox networks | grep nile || echo "âŒ Nile network not configured"

# Contract size analysis
contract-size:
	@echo "ğŸ“ Analyzing contract sizes..."
	@if [ -d "build/contracts" ]; then \
		echo "Contract sizes (bytecode):"; \
		for file in build/contracts/*.json; do \
			if [ -f "$$file" ]; then \
				name=$$(basename "$$file" .json); \
				size=$$(jq -r '.bytecode' "$$file" | wc -c); \
				if [ "$$size" -gt 2 ]; then \
					echo "  $$name: $$((size/2)) bytes"; \
				fi; \
			fi; \
		done; \
	else \
		echo "âŒ No build directory found. Run 'make compile' first."; \
	fi

# Performance testing
perf-test:
	@echo "âš¡ Running performance tests..."
	@echo "This may take several minutes..."
	npm run test:integration

# Documentation generation
docs:
	@echo "ğŸ“š Generating documentation..."
	@if command -v solidity-docgen >/dev/null 2>&1; then \
		solidity-docgen --solc-module solc --input contracts --output docs; \
		echo "âœ… Documentation generated in docs/"; \
	else \
		echo "âŒ solidity-docgen not installed. Install with: npm install -g solidity-docgen"; \
	fi

# Security analysis
security-check:
	@echo "ğŸ”’ Running security analysis..."
	@if command -v slither >/dev/null 2>&1; then \
		slither contracts/; \
	else \
		echo "âŒ Slither not installed. Install with: pip install slither-analyzer"; \
	fi

# Environment validation
validate-env:
	@echo "âœ… Validating environment..."
	@node --version | grep -q "v1[6789]" && echo "âœ… Node.js version OK" || echo "âŒ Node.js version should be >= 16"
	@npm --version | grep -q "[89]" && echo "âœ… npm version OK" || echo "âŒ npm version should be >= 8"
	@tronbox --version >/dev/null 2>&1 && echo "âœ… TronBox installed" || echo "âŒ TronBox not installed"
	@echo "Environment validation complete"

# Backup and restore
backup:
	@echo "ğŸ’¾ Creating backup..."
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	tar -czf "backup_$$timestamp.tar.gz" contracts migrations test tronbox-config.js package.json; \
	echo "âœ… Backup created: backup_$$timestamp.tar.gz"

# All-in-one commands for common workflows
quick-test: compile test-unit
	@echo "âš¡ Quick test completed"

full-test: clean compile test
	@echo "ğŸ§ª Full test suite completed"

deploy-test: compile deploy-dev test
	@echo "ğŸš€ Deploy and test completed" 